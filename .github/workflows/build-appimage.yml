name: Build AppImage & Shortcut

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    # ---------------------------------------------------------
    # PART 1: PREPARE THE APPIMAGE INTERNAL STRUCTURE
    # ---------------------------------------------------------
    - name: Prepare AppDir Structure
      run: |
        mkdir -p EDCoLauncher.AppDir/usr/bin

    - name: Set AppImage Icon (Robust)
      run: |
        # 1. Check for local icon, 2. Try download, 3. Create dummy if all else fails
        if [ -f "image_c7676d.png" ]; then
           cp "image_c7676d.png" EDCoLauncher.AppDir/.DirIcon
        else
           # Try downloading, but add "|| true" so it DOES NOT crash the build if it fails
           wget -q -O EDCoLauncher.AppDir/.DirIcon https://upload.wikimedia.org/wikipedia/commons/thumb/a/af/Tux.png/256px-Tux.png || true
        fi
        
        # Final safety check: if icon is still missing (0 bytes), touch it so the build continues
        if [ ! -s EDCoLauncher.AppDir/.DirIcon ]; then
           touch EDCoLauncher.AppDir/.DirIcon
        fi

    - name: Create Internal AppRun (The Logic)
      run: |
        cat << 'EOF' > EDCoLauncher.AppDir/AppRun
        #!/bin/bash
        APPDIR="$(dirname "$(readlink -f "${0}")")"
        TARGET_DIR="$PWD"
        
        INTERNAL_SCRIPT="$APPDIR/usr/bin/EDCoLauncher.sh"
        INTERNAL_CONFIG="$APPDIR/usr/bin/EDCoLauncher_config"
        EXTERNAL_CONFIG="$TARGET_DIR/EDCoLauncher_config"
        
        # Copy config to current dir if it doesn't exist
        if [ ! -f "$EXTERNAL_CONFIG" ]; then
            echo "Creating default configuration file in $TARGET_DIR..."
            cp "$INTERNAL_CONFIG" "$EXTERNAL_CONFIG"
        fi
        
        # Run the internal script
        exec "$INTERNAL_SCRIPT" "$@"
        EOF
        chmod +x EDCoLauncher.AppDir/AppRun

    - name: Create Internal Desktop File (Metadata)
      run: |
        cat <<EOF > EDCoLauncher.AppDir/EDCoLauncher.desktop
        [Desktop Entry]
        Name=EDCoLauncher
        Exec=AppRun
        Icon=steam_icon_359320
        Type=Application
        Categories=Game;Utility;
        Terminal=false
        EOF

    - name: Copy & Permission Scripts
      run: |
        cp EDCoLauncher.sh EDCoLauncher.AppDir/usr/bin/
        cp EDCoLauncher_config EDCoLauncher.AppDir/usr/bin/
        chmod +x EDCoLauncher.AppDir/usr/bin/EDCoLauncher.sh

    # ---------------------------------------------------------
    # PART 2: BUILD THE APPIMAGE (FIXED FOR GITHUB RUNNERS)
    # ---------------------------------------------------------
    - name: Build AppImage
      run: |
        # Download tool
        wget -q https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage
        chmod +x appimagetool-x86_64.AppImage

        # EXTRACT it explicitly to bypass FUSE errors (Exit Code 8)
        ./appimagetool-x86_64.AppImage --appimage-extract
        
        # Run the extracted tool to build your AppImage
        export ARCH=x86_64
        ./squashfs-root/AppRun EDCoLauncher.AppDir

        # Rename output
        mv EDCoLauncher-x86_64.AppImage Elite_Dangerous_EDCoLauncher-x86_64.AppImage

    # ---------------------------------------------------------
    # PART 3: GENERATE THE USER SHORTCUT
    # ---------------------------------------------------------
    - name: Create Desktop Shortcut File
      run: |
        cat <<EOF > "Elite Dangerous (EDCoLauncher).desktop"
        [Desktop Entry]
        Name=Elite Dangerous (EDCoLauncher)
        Exec=steam steam://rungameid/359320
        Icon=steam_icon_359320
        Type=Application
        Categories=Game;Utility;
        Terminal=false
        EOF
        chmod +x "Elite Dangerous (EDCoLauncher).desktop"

    # ---------------------------------------------------------
    # PART 4: UPLOAD EVERYTHING
    # ---------------------------------------------------------
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: EDCoLauncher-Release
        path: |
          Elite_Dangerous_EDCoLauncher-x86_64.AppImage
          Elite Dangerous (EDCoLauncher).desktop
